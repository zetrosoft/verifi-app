<!doctype html>
<html lang="en">
<head>
    <title>Code coverage report for contracts/AIEscrowMarketplace.sol</title>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="../prettify.css" />
    <link rel="stylesheet" href="../base.css" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style type='text/css'>
        .coverage-summary .sorter {
            background-image: url(../sort-arrow-sprite.png);
        }
    </style>
</head>
<body>
<div class='wrapper'>
  <div class='pad1'>
    <h1>
      <a href="../index.html">all files</a> / <a href="index.html">contracts/</a> AIEscrowMarketplace.sol
    </h1>
    <div class='clearfix'>
      <div class='fl pad1y space-right2'>
        <span class="strong">100% </span>
        <span class="quiet">Statements</span>
        <span class='fraction'>30/30</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">60% </span>
        <span class="quiet">Branches</span>
        <span class='fraction'>30/50</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">100% </span>
        <span class="quiet">Functions</span>
        <span class='fraction'>11/11</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">100% </span>
        <span class="quiet">Lines</span>
        <span class='fraction'>44/44</span>
      </div>
    </div>
  </div>
  <div class='status-line high'></div>
<pre><table class="coverage">
<tr><td class="line-count quiet">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165</td><td class="line-coverage quiet"><span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">6×</span>
<span class="cline-any cline-yes">6×</span>
<span class="cline-any cline-yes">6×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">4×</span>
<span class="cline-any cline-yes">4×</span>
<span class="cline-any cline-yes">4×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">12×</span>
<span class="cline-any cline-yes">12×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">7×</span>
<span class="cline-any cline-yes">7×</span>
<span class="cline-any cline-yes">7×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">7×</span>
<span class="cline-any cline-yes">7×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">7×</span>
<span class="cline-any cline-yes">7×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">6×</span>
<span class="cline-any cline-yes">6×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">5×</span>
<span class="cline-any cline-yes">5×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">4×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">4×</span>
<span class="cline-any cline-yes">4×</span>
<span class="cline-any cline-yes">4×</span>
<span class="cline-any cline-yes">4×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span></td><td class="text"><pre class="prettyprint lang-js">// SPDX-License-Identifier: MIT
pragma solidity ^0.8.20;
&nbsp;
import "@openzeppelin/contracts/access/Ownable.sol";
import "@openzeppelin/contracts/utils/ReentrancyGuard.sol";
&nbsp;
/**
 * @title AIEscrowMarketplace
 * @author Zetrosoft
 * @notice Kontrak ini mengelola alur kerja escrow untuk pekerjaan antara client dan freelancer,
 * dengan verifikasi otomatis yang dilakukan oleh AI Agent.
 */
contract AIEscrowMarketplace is Ownable, ReentrancyGuard {
&nbsp;
    // =================================================================
    // State Variables
    // =================================================================
&nbsp;
    address public aiAgentAddress;
    uint256 public nextJobId;
&nbsp;
    enum Status {
        Created,
        FundsDeposited,
        WorkSubmitted,
        Verified,
        Completed,
        Cancelled // Untuk penanganan sengketa di masa depan
    }
&nbsp;
    struct Job {
        address payable client;
        address payable freelancer;
        uint256 amount;
        string workDescriptionIPFSHash;
        string resultIPFSHash;
        Status status;
    }
&nbsp;
    mapping(uint256 =&gt; Job) public jobs;
&nbsp;
    // =================================================================
    // Events
    // =================================================================
&nbsp;
    event JobCreated(uint256 indexed jobId, address indexed client, address indexed freelancer, uint256 amount);
    event FundsDeposited(uint256 indexed jobId, uint256 amount);
    event WorkSubmitted(uint256 indexed jobId, address indexed freelancer, string resultIPFSHash);
    event WorkVerified(uint256 indexed jobId, bool isApproved);
    event FundsReleased(uint256 indexed jobId, address indexed recipient, uint256 amount);
    event AiAgentAddressUpdated(address indexed newAddress);
&nbsp;
    // =================================================================
    // Modifiers
    // =================================================================
&nbsp;
    modifier onlyAiAgent() {
        require(msg.sender == aiAgentAddress, "AIEscrow: Caller is not the AI Agent");
        _;
    }
&nbsp;
    modifier onlyJobClient(uint256 _jobId) {
        <span class="missing-if-branch" title="else path not taken" >E</span>require(jobs[_jobId].client != address(0), "AIEscrow: Job does not exist");
        <span class="missing-if-branch" title="else path not taken" >E</span>require(msg.sender == jobs[_jobId].client, "AIEscrow: Caller is not the job client");
        _;
    }
&nbsp;
    modifier onlyJobFreelancer(uint256 _jobId) {
        <span class="missing-if-branch" title="else path not taken" >E</span>require(jobs[_jobId].freelancer != address(0), "AIEscrow: Job does not exist");
        <span class="missing-if-branch" title="else path not taken" >E</span>require(msg.sender == jobs[_jobId].freelancer, "AIEscrow: Caller is not the job freelancer");
        _;
    }
&nbsp;
    modifier atJobStatus(uint256 _jobId, Status _status) {
        <span class="missing-if-branch" title="else path not taken" >E</span>require(jobs[_jobId].status == _status, "AIEscrow: Job is not in the required status");
        _;
    }
&nbsp;
    // =================================================================
    // Constructor &amp; Admin Functions
    // =================================================================
&nbsp;
    constructor(address _initialAiAgentAddress) Ownable(msg.sender) {
        <span class="missing-if-branch" title="else path not taken" >E</span>require(_initialAiAgentAddress != address(0), "AIEscrow: Initial AI Agent address cannot be the zero address");
        aiAgentAddress = _initialAiAgentAddress;
        emit AiAgentAddressUpdated(_initialAiAgentAddress);
    }
&nbsp;
    function setAiAgentAddress(address _newAiAgentAddress) external onlyOwner {
        <span class="missing-if-branch" title="else path not taken" >E</span>require(_newAiAgentAddress != address(0), "AIEscrow: New AI Agent address cannot be the zero address");
        aiAgentAddress = _newAiAgentAddress;
        emit AiAgentAddressUpdated(_newAiAgentAddress);
    }
&nbsp;
    // =================================================================
    // Core Functions
    // =================================================================
&nbsp;
    function createJob(address payable _freelancer, uint256 _amount, string memory _workDescriptionIPFSHash) external {
        <span class="missing-if-branch" title="else path not taken" >E</span>require(_freelancer != address(0), "AIEscrow: Invalid freelancer address");
        <span class="missing-if-branch" title="else path not taken" >E</span>require(_amount &gt; 0, "AIEscrow: Amount must be greater than zero");
        <span class="missing-if-branch" title="else path not taken" >E</span>require(bytes(_workDescriptionIPFSHash).length &gt; 0, "AIEscrow: Work description IPFS hash cannot be empty");
&nbsp;
        uint256 jobId = nextJobId;
        jobs[jobId] = Job({
            client: payable(msg.sender),
            freelancer: _freelancer,
            amount: _amount,
            workDescriptionIPFSHash: _workDescriptionIPFSHash,
            resultIPFSHash: "",
            status: Status.Created
        });
&nbsp;
        nextJobId++;
        emit JobCreated(jobId, msg.sender, _freelancer, _amount);
    }
&nbsp;
    function depositFunds(uint256 _jobId) external payable <span class="missing-if-branch" title="else path not taken" >E</span>nonReentrant <span class="missing-if-branch" title="else path not taken" >E</span>onlyJobClient(_jobId) <span class="missing-if-branch" title="else path not taken" >E</span>atJobStatus(_jobId, Status.Created) {
        Job storage job = jobs[_jobId];
        require(msg.value == job.amount, "AIEscrow: Incorrect deposit amount");
&nbsp;
        job.status = Status.FundsDeposited;
        emit FundsDeposited(_jobId, msg.value);
    }
&nbsp;
    function submitWork(uint256 _jobId, string memory _resultIPFSHash) external <span class="missing-if-branch" title="else path not taken" >E</span>onlyJobFreelancer(_jobId) <span class="missing-if-branch" title="else path not taken" >E</span>atJobStatus(_jobId, Status.FundsDeposited) {
        <span class="missing-if-branch" title="else path not taken" >E</span>require(bytes(_resultIPFSHash).length &gt; 0, "AIEscrow: Result IPFS hash cannot be empty");
&nbsp;
        Job storage job = jobs[_jobId];
        job.resultIPFSHash = _resultIPFSHash;
        job.status = Status.WorkSubmitted;
        emit WorkSubmitted(_jobId, job.freelancer, _resultIPFSHash);
    }
&nbsp;
    function verifyWork(uint256 _jobId, bool _isApproved) external <span class="missing-if-branch" title="else path not taken" >E</span>nonReentrant onlyAiAgent <span class="missing-if-branch" title="else path not taken" >E</span>atJobStatus(_jobId, Status.WorkSubmitted) {
        Job storage job = jobs[_jobId];
        job.status = Status.Verified;
        emit WorkVerified(_jobId, _isApproved);
&nbsp;
        if (_isApproved) {
            _releaseFunds(_jobId);
        } else {
            // For MVP, if work is rejected, we cancel it.
            // Future iterations could involve a dispute/arbitration process.
            job.status = Status.Cancelled;
        }
    }
&nbsp;
    // =================================================================
    // Internal Functions
    // =================================================================
&nbsp;
    function _releaseFunds(uint256 _jobId) internal {
        Job storage job = jobs[_jobId];
        // A final check on status, although verifyWork controls this flow.
        <span class="missing-if-branch" title="else path not taken" >E</span>require(job.status == Status.Verified, "AIEscrow: Job not in verified status for fund release");
&nbsp;
        job.status = Status.Completed;
        (bool success, ) = job.freelancer.call{value: job.amount}("");
        <span class="missing-if-branch" title="else path not taken" >E</span>require(success, "AIEscrow: Failed to release funds to freelancer");
&nbsp;
        emit FundsReleased(_jobId, job.freelancer, job.amount);
    }
}
&nbsp;</pre></td></tr>
</table></pre>
<div class='push'></div><!-- for sticky footer -->
</div><!-- /wrapper -->
<div class='footer quiet pad2 space-top1 center small'>
  Code coverage
  generated by <a href="http://istanbul-js.org/" target="_blank">istanbul</a> at Thu Nov 20 2025 08:31:20 GMT+0700 (Western Indonesia Time)
</div>
</div>
<script src="../prettify.js"></script>
<script>
window.onload = function () {
        if (typeof prettyPrint === 'function') {
            prettyPrint();
        }
};
</script>
<script src="../sorter.js"></script>
</body>
</html>
